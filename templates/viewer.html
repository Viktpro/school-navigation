<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä | –ú–ë–û–£ –°–û–® ‚Ññ1</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2d3748;
    }

    /* –®–∞–ø–∫–∞ */
    .modern-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #1a202c;
      padding: 1rem 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid #f39c12;
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .logo-image img {
      height: 60px;
      width: auto;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .school-fullname {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2d3748;
    }

    .school-city {
      font-size: 0.9rem;
      font-weight: 400;
      color: #718096;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .nav-link {
      color: #4a5568;
      text-decoration: none;
      font-weight: 600;
      padding: 0.5rem 1.2rem;
      border-radius: 50px;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      background: #667eea;
      color: white;
    }

    .nav-link.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .main-container {
      display: flex;
      max-width: 1400px;
      margin: 20px auto;
      gap: 20px;
      padding: 0 20px;
      transition: all 0.3s ease;
    }

    .control-panel {
      flex: 0 0 350px;
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      height: fit-content;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .map-panel {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º */
    .fullscreen-mode {
      overflow: hidden;
    }

    .fullscreen-mode .modern-header,
    .fullscreen-mode .control-panel,
    .fullscreen-mode footer {
      display: none;
    }

    .fullscreen-mode .main-container {
      margin: 0;
      padding: 0;
      max-width: 100%;
      height: 100vh;
    }

    .fullscreen-mode .map-panel {
      border-radius: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
    }

    .fullscreen-mode .map-container {
      height: 100vh;
      width: 100vw;
      border-radius: 0;
      border: none;
    }

    .fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: white;
      color: #4a5568;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }

    .fullscreen-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }

    .fullscreen-btn:active {
      transform: scale(0.95);
    }

    .exit-fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: #e53e3e;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 20;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .exit-fullscreen-btn:hover {
      background: #c53030;
      transform: scale(1.1);
    }

    .fullscreen-mode .exit-fullscreen-btn {
      display: flex;
    }

    .fullscreen-mode .fullscreen-btn {
      display: none;
    }

    h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #2d3748;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }

    h3 {
      font-size: 1rem;
      color: #718096;
      margin-bottom: 0.5rem;
    }

    select, button {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      margin: 0.5rem 0;
      font-family: 'Inter', sans-serif;
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è QR-—Å–∫–∞–Ω–µ—Ä–∞ */
    .qr-container {
      position: relative;
      width: 100%;
      min-height: 300px;
      background: #f7fafc;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
      border: 2px dashed #cbd5e0;
    }

    #qr-reader {
      width: 100%;
      min-height: 300px;
    }

    .qr-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .qr-tab {
      flex: 1;
      padding: 10px;
      background: #edf2f7;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
    }

    .qr-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .qr-content {
      display: none;
    }

    .qr-content.active {
      display: block;
    }

    .qr-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
      color: #718096;
      min-height: 250px;
    }

    .qr-placeholder p {
      margin: 10px 0;
    }

    .camera-button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s;
    }

    .camera-button:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .file-input {
      width: 100%;
      padding: 20px;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      margin: 10px 0;
    }

    .file-input:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .camera-error {
      color: #e53e3e;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    #current-location {
      margin-top: 10px;
      padding: 10px;
      background: #f0fff0;
      border-left: 4px solid #48bb78;
      border-radius: 8px;
      display: none;
    }

    #current-location.active {
      display: block;
    }

    .or-divider {
      text-align: center;
      margin: 15px 0;
      position: relative;
    }

    .or-divider::before,
    .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background: #e2e8f0;
    }

    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }

    .or-divider span {
      background: white;
      padding: 0 10px;
      color: #a0aec0;
      font-size: 0.9rem;
    }

    .map-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      touch-action: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∂–µ—Å—Ç—ã –±—Ä–∞—É–∑–µ—Ä–∞ */
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      background: white;
      cursor: grab;
      touch-action: none; /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    }

    #mapCanvas:active {
      cursor: grabbing;
    }

    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }

    .map-control-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: white;
      color: #4a5568;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      border: 1px solid #e2e8f0;
    }

    .map-control-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }

    .map-control-btn:active {
      transform: scale(0.95);
    }

    .floor-selector {
      position: absolute;
      left: 20px;
      bottom: 20px;
      background: white;
      border-radius: 40px;
      display: flex;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      border: 1px solid #e2e8f0;
    }

    .floor-btn {
      padding: 10px 20px;
      border: none;
      background: white;
      color: #4a5568;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }

    .floor-btn:hover {
      background: #edf2f7;
    }

    .floor-btn:active {
      background: #cbd5e0;
    }

    .floor-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .point-tooltip {
      position: absolute;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      font-size: 0.9rem;
      pointer-events: none;
      z-index: 20;
      display: none;
      border: 1px solid #e2e8f0;
    }

    /* –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è - —Ç–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
    .navigation-panel {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .direction-arrow {
      font-size: 3rem;
      margin-bottom: 10px;
      color: #f39c12;
    }

    .direction-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .direction-hint {
      color: #718096;
      font-size: 0.9rem;
    }

    .floor-change {
      color: #667eea;
      font-weight: 600;
      margin-top: 10px;
    }

    .success-message, .error-message {
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .success-message {
      background: #f0fff4;
      color: #276749;
    }

    .error-message {
      background: #fff5f5;
      color: #c53030;
    }

    footer {
      text-align: center;
      padding: 1rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 1rem;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .map-container {
        height: 400px;
      }

      .fullscreen-mode .map-container {
        height: 100vh;
      }

      .control-panel {
        flex: auto;
      }

      .floor-btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }

      .map-control-btn {
        width: 40px;
        height: 40px;
      }
    }

    @media (max-width: 480px) {
      .modern-header {
        padding: 0.8rem 1rem;
      }

      .logo-image img {
        height: 40px;
      }

      .school-fullname {
        font-size: 1rem;
      }

      .school-city {
        font-size: 0.8rem;
      }

      .nav-link {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }

      h2 {
        font-size: 1.1rem;
      }

      .qr-tabs {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header class="modern-header">
    <div class="header-container">
      <div class="logo-section">
        <div class="logo-image">
          <img src="/static/images/school_logo.png" alt="–ú–ë–û–£ –°–û–® ‚Ññ1">
        </div>
        <div class="logo-text">
          <div class="school-fullname">–ú–ë–û–£ –°–û–® ‚Ññ1</div>
          <div class="school-city">–≥. –ë–æ–ª—å—à–æ–π –ö–∞–º–µ–Ω—å</div>
        </div>
      </div>

      <div class="nav-links">
        <a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/viewer" class="nav-link active">–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
        <a href="/admin" class="nav-link">–ê–¥–º–∏–Ω–∫–∞</a>
      </div>
    </div>
  </header>

  <div class="main-container">
    <div class="control-panel">
      <h2>–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h2>

      <div class="scan-section">
        <h3>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</h3>

        <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="qr-tabs">
          <button class="qr-tab active" onclick="switchQRMode('camera')">üì∑ –ö–∞–º–µ—Ä–∞</button>
          <button class="qr-tab" onclick="switchQRMode('file')">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        </div>

        <!-- –†–µ–∂–∏–º –∫–∞–º–µ—Ä—ã -->
        <div id="camera-mode" class="qr-content active">
          <div class="qr-container" id="qr-container">
            <div id="qr-reader"></div>
            <div id="camera-placeholder" class="qr-placeholder" style="display: none;">
              <p>üì∑ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</p>
              <button class="camera-button" onclick="startCamera()">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
              <div id="camera-error" class="camera-error"></div>
            </div>
          </div>
        </div>

        <!-- –†–µ–∂–∏–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div id="file-mode" class="qr-content">
          <div class="qr-container">
            <div class="qr-placeholder">
              <p>üìÅ –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å QR-–∫–æ–¥–æ–º</p>
              <input type="file" id="qr-file-input" class="file-input" accept="image/*">
              <div id="file-error" class="camera-error"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="or-divider">
        <span>–∏–ª–∏</span>
      </div>

      <div class="manual-section">
        <h3>–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
        <select id="manual-location">
          <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</option>
        </select>
        <button id="set-manual-location" disabled>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>

      <div id="current-location"></div>

      <h2 style="margin-top: 20px;">–ö—É–¥–∞ –∏–¥–µ–º?</h2>
      <select id="destination">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è...</option>
      </select>
      <button id="find-route" disabled>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>

      <!-- –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è - —Ç–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div id="navigation-panel" class="navigation-panel" style="display: none;">
        <div class="direction-arrow" id="direction-arrow">‚¨ÜÔ∏è</div>
        <div class="direction-text" id="direction-text">–ò–¥–∏—Ç–µ –ø—Ä—è–º–æ</div>
        <div class="direction-hint" id="direction-hint">–°–ª–µ–¥—É–π—Ç–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É</div>
        <div class="floor-change" id="floor-change"></div>
      </div>

      <div id="success-message" class="success-message"></div>
      <div id="error-message" class="error-message"></div>
    </div>

    <div class="map-panel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
        <h2 style="margin-bottom: 0; border-bottom: none;">–ö–∞—Ä—Ç–∞ —à–∫–æ–ª—ã</h2>
        <button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂</button>
        <button class="exit-fullscreen-btn" id="exit-fullscreen-btn" onclick="exitFullscreen()">‚úï</button>
      </div>
      <div class="map-container">
        <canvas id="mapCanvas"></canvas>

        <div class="map-controls">
          <button class="map-control-btn" id="zoomIn" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">+</button>
          <button class="map-control-btn" id="zoomOut" title="–û—Ç–¥–∞–ª–∏—Ç—å">‚àí</button>
          <button class="map-control-btn" id="fitView" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë">‚§¢</button>
        </div>

        <div class="floor-selector">
          <button class="floor-btn active" data-floor="1">1</button>
          <button class="floor-btn" data-floor="2">2</button>
          <button class="floor-btn" data-floor="3">3</button>
        </div>

        <div class="point-tooltip" id="pointTooltip"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>¬© –ú–ë–û–£ –°–û–® ‚Ññ1</p>
  </footer>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    class SchoolMap {
      constructor() {
        this.canvas = document.getElementById('mapCanvas');
        this.ctx = this.canvas.getContext('2d');

        this.resizeCanvas();

        this.points = [];
        this.walls = {1: [], 2: [], 3: []};
        this.routes = {};
        this.currentFloor = 1;

        this.currentLocation = null;
        this.destination = null;
        this.currentRoute = null;
        this.currentStep = 0;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã
        this.offsetX = 0;
        this.offsetY = 0;
        this.scale = 1;
        this.minScale = 0.3;
        this.maxScale = 5;

        // –î–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º—ã—à—å—é
        this.isDragging = false;
        this.lastX = 0;
        this.lastY = 0;

        // –î–ª—è –º—É–ª—å—Ç–∏—Ç–∞—á –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö
        this.touchDistance = 0;
        this.touchCenter = { x: 0, y: 0 };

        this.hoveredPoint = null;
        this.tooltip = document.getElementById('pointTooltip');

        this.manualLocationSelect = document.getElementById('manual-location');
        this.setLocationBtn = document.getElementById('set-manual-location');
        this.destinationSelect = document.getElementById('destination');
        this.findRouteBtn = document.getElementById('find-route');
        this.currentLocationDiv = document.getElementById('current-location');
        this.navigationPanel = document.getElementById('navigation-panel');
        this.directionArrow = document.getElementById('direction-arrow');
        this.directionText = document.getElementById('direction-text');
        this.directionHint = document.getElementById('direction-hint');
        this.floorChange = document.getElementById('floor-change');
        this.successMessage = document.getElementById('success-message');
        this.errorMessage = document.getElementById('error-message');

        // –î–ª—è QR-—Å–∫–∞–Ω–µ—Ä–∞
        this.qrScanner = null;
        this.qrReader = document.getElementById('qr-reader');
        this.cameraPlaceholder = document.getElementById('camera-placeholder');
        this.cameraError = document.getElementById('camera-error');
        this.fileInput = document.getElementById('qr-file-input');
        this.fileError = document.getElementById('file-error');

        // –î–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        this.isFullscreen = false;

        this.init();

        // –°—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        this.requestCameraPermission();
      }

      resizeCanvas() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
      }

      async init() {
        await this.loadData();
        await this.loadRoutes();
        this.setupControls();
        this.setupMouseEvents();
        this.setupTouchEvents();
        this.fitToScreen();
        this.populateSelects();
        this.setupFileInput();

        window.addEventListener('resize', () => {
          this.resizeCanvas();
          if (!this.isFullscreen) {
            this.fitToScreen();
          } else {
            this.draw();
          }
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        document.addEventListener('fullscreenchange', () => {
          this.handleFullscreenChange();
        });
        document.addEventListener('webkitfullscreenchange', () => {
          this.handleFullscreenChange();
        });
        document.addEventListener('mozfullscreenchange', () => {
          this.handleFullscreenChange();
        });
        document.addEventListener('MSFullscreenChange', () => {
          this.handleFullscreenChange();
        });
      }

      handleFullscreenChange() {
        const isFullscreen = !!(document.fullscreenElement ||
                               document.webkitFullscreenElement ||
                               document.mozFullScreenElement ||
                               document.msFullscreenElement);

        if (isFullscreen) {
          document.body.classList.add('fullscreen-mode');
          this.isFullscreen = true;
        } else {
          document.body.classList.remove('fullscreen-mode');
          this.isFullscreen = false;
          this.fitToScreen();
        }

        setTimeout(() => {
          this.resizeCanvas();
          this.draw();
        }, 100);
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      setupTouchEvents() {
        this.canvas.addEventListener('touchstart', (e) => {
          e.preventDefault();

          if (e.touches.length === 1) {
            // –û–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ - –Ω–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            this.isDragging = true;
            this.lastX = e.touches[0].clientX;
            this.lastY = e.touches[0].clientY;
          } else if (e.touches.length === 2) {
            // –î–≤–∞ –∫–∞—Å–∞–Ω–∏—è - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
            this.touchDistance = Math.hypot(
              touch1.clientX - touch2.clientX,
              touch1.clientY - touch2.clientY
            );

            // –¶–µ–Ω—Ç—Ä –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
            this.touchCenter.x = (touch1.clientX + touch2.clientX) / 2;
            this.touchCenter.y = (touch1.clientY + touch2.clientY) / 2;
          }
        }, { passive: false });

        this.canvas.addEventListener('touchmove', (e) => {
          e.preventDefault();

          if (e.touches.length === 1 && this.isDragging) {
            // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º
            const dx = e.touches[0].clientX - this.lastX;
            const dy = e.touches[0].clientY - this.lastY;

            this.offsetX += dx;
            this.offsetY += dy;

            this.lastX = e.touches[0].clientX;
            this.lastY = e.touches[0].clientY;

            this.draw();
          } else if (e.touches.length === 2) {
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];

            const newDistance = Math.hypot(
              touch1.clientX - touch2.clientX,
              touch1.clientY - touch2.clientY
            );

            if (this.touchDistance > 0) {
              // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
              const rect = this.canvas.getBoundingClientRect();
              const centerX = (touch1.clientX + touch2.clientX) / 2 - rect.left;
              const centerY = (touch1.clientY + touch2.clientY) / 2 - rect.top;

              const worldX = (centerX - this.offsetX) / this.scale;
              const worldY = (centerY - this.offsetY) / this.scale;

              const scaleFactor = newDistance / this.touchDistance;
              const newScale = Math.min(Math.max(this.scale * scaleFactor, this.minScale), this.maxScale);

              this.offsetX = centerX - worldX * newScale;
              this.offsetY = centerY - worldY * newScale;
              this.scale = newScale;
            }

            this.touchDistance = newDistance;
            this.draw();
          }
        }, { passive: false });

        this.canvas.addEventListener('touchend', (e) => {
          e.preventDefault();
          this.isDragging = false;
          this.touchDistance = 0;
        });

        this.canvas.addEventListener('touchcancel', (e) => {
          e.preventDefault();
          this.isDragging = false;
          this.touchDistance = 0;
        });
      }

      // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      async requestCameraPermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          stream.getTracks().forEach(track => track.stop());
          this.showCameraPlaceholder();
        } catch (err) {
          console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ:', err);
          this.showCameraPlaceholder();
          this.cameraError.textContent = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞.';
        }
      }

      showCameraPlaceholder() {
        if (this.qrReader) {
          this.qrReader.style.display = 'none';
        }
        if (this.cameraPlaceholder) {
          this.cameraPlaceholder.style.display = 'flex';
        }
      }

      hideCameraPlaceholder() {
        if (this.cameraPlaceholder) {
          this.cameraPlaceholder.style.display = 'none';
        }
        if (this.qrReader) {
          this.qrReader.style.display = 'block';
        }
      }

      async startCamera() {
        this.cameraError.textContent = '';

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          stream.getTracks().forEach(track => track.stop());

          this.hideCameraPlaceholder();

          this.qrScanner = new Html5Qrcode("qr-reader");

          const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          };

          await this.qrScanner.start(
            { facingMode: "environment" },
            config,
            (decodedText) => this.handleQRScan(decodedText),
            (error) => {
              console.log('QR Scan status:', error);
            }
          );

        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
          this.cameraError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
          this.showCameraPlaceholder();
        }
      }

      setupFileInput() {
        this.fileInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;

          this.fileError.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';

          Html5Qrcode.scanFile(file, true)
            .then(decodedText => {
              this.fileError.textContent = '';
              this.handleQRScan(decodedText);
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', err);
              this.fileError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR-–∫–æ–¥ –≤ —Ñ–∞–π–ª–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.';
            });
        });
      }

      handleQRScan(decodedText) {
        try {
          const url = new URL(decodedText);
          const pointId = url.searchParams.get('point');

          if (pointId) {
            const point = this.points.find(p => p.id === pointId);
            if (point) {
              this.setLocation(pointId);

              if (this.qrScanner) {
                this.qrScanner.stop().then(() => {
                  this.qrScanner = null;
                  this.showCameraPlaceholder();
                }).catch(() => {
                  this.showCameraPlaceholder();
                });
              }

              this.showSuccess(`QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${point.name}`);
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–∞:', e);
          this.showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞');
        }
      }

      stopQRScanner() {
        if (this.qrScanner) {
          this.qrScanner.stop().then(() => {
            this.qrScanner = null;
            this.showCameraPlaceholder();
          }).catch(() => {
            this.showCameraPlaceholder();
          });
        }
      }

      async loadData() {
        try {
          const pointsRes = await fetch('/api/points');
          this.points = await pointsRes.json();
          console.log('‚úÖ –¢–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.points.length);

          const wallsRes = await fetch('/api/load-map');
          const wallsData = await wallsRes.json();

          if (wallsData.floors) {
            this.walls = {
              1: wallsData.floors[1]?.walls || [],
              2: wallsData.floors[2]?.walls || [],
              3: wallsData.floors[3]?.walls || []
            };
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
      }

      async loadRoutes() {
        try {
          const routesRes = await fetch('/api/routes');
          this.routes = await routesRes.json();
          console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', Object.keys(this.routes).length);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤:', error);
          this.routes = {};
        }
      }

      populateSelects() {
        this.manualLocationSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</option>';
        this.destinationSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è...</option>';

        const routePoints = new Set();
        Object.values(this.routes).forEach(route => {
          routePoints.add(route.startId);
          routePoints.add(route.endId);
        });

        const pointsArray = Array.from(routePoints)
          .map(id => this.points.find(p => p.id === id))
          .filter(p => p)
          .sort((a, b) => a.name.localeCompare(b.name));

        if (pointsArray.length === 0) {
          this.manualLocationSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</option>';
          this.destinationSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</option>';
          this.showError('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ');
          return;
        }

        pointsArray.forEach(point => {
          const optionText = `${point.name} (${point.floor} —ç—Ç–∞–∂)`;

          const option1 = document.createElement('option');
          option1.value = point.id;
          option1.textContent = optionText;
          this.manualLocationSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = point.id;
          option2.textContent = optionText;
          this.destinationSelect.appendChild(option2);
        });

        this.manualLocationSelect.disabled = false;
        this.destinationSelect.disabled = false;
        this.updateLocationButton();
        this.updateFindRouteButton();
      }

      setupControls() {
        document.getElementById('zoomIn').addEventListener('click', () => {
          this.scale = Math.min(this.scale * 1.2, this.maxScale);
          this.draw();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
          this.scale = Math.max(this.scale / 1.2, this.minScale);
          this.draw();
        });

        document.getElementById('fitView').addEventListener('click', () => {
          this.fitToScreen();
        });

        document.querySelectorAll('.floor-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            this.currentFloor = parseInt(btn.dataset.floor);
            this.fitToScreen();
          });
        });

        this.manualLocationSelect.addEventListener('change', () => this.updateLocationButton());
        this.setLocationBtn.addEventListener('click', () => {
          const locationId = this.manualLocationSelect.value;
          if (locationId) {
            this.stopQRScanner();
            this.setLocation(locationId);
          }
        });

        this.destinationSelect.addEventListener('change', () => this.updateFindRouteButton());
        this.findRouteBtn.addEventListener('click', () => {
          const destinationId = this.destinationSelect.value;
          if (destinationId && this.currentLocation) this.setDestination(destinationId);
        });
      }

      updateLocationButton() {
        this.setLocationBtn.disabled = !this.manualLocationSelect.value;
      }

      updateFindRouteButton() {
        this.findRouteBtn.disabled = !(this.currentLocation && this.destinationSelect.value);
      }

      setLocation(pointId) {
        const point = this.points.find(p => p.id === pointId);
        if (point) {
          this.currentLocation = point;
          this.currentLocationDiv.textContent = `–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å: ${point.name} (${point.floor} —ç—Ç–∞–∂)`;
          this.currentLocationDiv.classList.add('active');
          this.updateFindRouteButton();
          this.centerOnPoint(point);
          this.showSuccess(`–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`);

          this.currentRoute = null;
          this.destination = null;
          this.destinationSelect.value = "";
          this.navigationPanel.style.display = 'none';
          this.draw();
        }
      }

      setDestination(pointId) {
        const point = this.points.find(p => p.id === pointId);
        if (point) {
          this.destination = point;
          this.findRoute();
        }
      }

      centerOnPoint(point) {
        this.offsetX = this.canvas.width / 2 - point.x * this.scale;
        this.offsetY = this.canvas.height / 2 - point.y * this.scale;
        this.currentFloor = point.floor;

        document.querySelectorAll('.floor-btn').forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.floor) === point.floor);
        });

        this.draw();
      }

      findRoute() {
        if (!this.currentLocation || !this.destination) return;

        const startId = this.currentLocation.id;
        const endId = this.destination.id;
        const routeKey = `${startId}_${endId}`;
        const reverseKey = `${endId}_${startId}`;

        let routePoints = null;

        if (this.routes[routeKey]) {
          routePoints = this.routes[routeKey].points;
        } else if (this.routes[reverseKey]) {
          routePoints = [...this.routes[reverseKey].points].reverse();
        }

        if (routePoints && routePoints.length > 1) {
          this.currentRoute = routePoints;
          this.currentStep = 0;
          this.updateNavigation();
          this.navigationPanel.style.display = 'block';
          this.showSuccess('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω');
          this.fitToRoute();
        } else {
          this.currentRoute = null;
          this.navigationPanel.style.display = 'none';
          this.showError('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        this.draw();
      }

      updateNavigation() {
        if (!this.currentRoute || this.currentRoute.length < 2) return;

        const current = this.currentRoute[this.currentStep];
        const next = this.currentRoute[this.currentStep + 1];

        const dx = next.x - current.x;
        const dy = next.y - current.y;

        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        let direction = '';
        let arrow = '';

        if (angle > -45 && angle <= 45) {
          direction = '–Ω–∞–ø—Ä–∞–≤–æ';
          arrow = '‚û°Ô∏è';
        } else if (angle > 45 && angle <= 135) {
          direction = '–≤–Ω–∏–∑';
          arrow = '‚¨áÔ∏è';
        } else if (angle > 135 || angle <= -135) {
          direction = '–Ω–∞–ª–µ–≤–æ';
          arrow = '‚¨ÖÔ∏è';
        } else {
          direction = '–≤–≤–µ—Ä—Ö';
          arrow = '‚¨ÜÔ∏è';
        }

        this.directionArrow.textContent = arrow;
        this.directionText.textContent = `–ò–¥–∏—Ç–µ ${direction}`;

        if (current.floor !== next.floor) {
          this.floorChange.textContent = `–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ ${next.floor} —ç—Ç–∞–∂`;
        } else {
          this.floorChange.textContent = '';
        }

        this.directionHint.textContent = `–û—Ç ${current.name || '—Ç–æ—á–∫–∏'} –∫ ${next.name || '—Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–µ'}`;
      }

      fitToRoute() {
        if (!this.currentRoute || this.currentRoute.length === 0) return;

        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

        this.currentRoute.forEach(point => {
          minX = Math.min(minX, point.x);
          minY = Math.min(minY, point.y);
          maxX = Math.max(maxX, point.x);
          maxY = Math.max(maxY, point.y);
        });

        const padding = 50;
        minX -= padding;
        minY -= padding;
        maxX += padding;
        maxY += padding;

        const mapWidth = maxX - minX;
        const mapHeight = maxY - minY;

        this.scale = Math.min(this.canvas.width / mapWidth, this.canvas.height / mapHeight) * 0.9;
        this.scale = Math.min(Math.max(this.scale, this.minScale), this.maxScale);

        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;

        this.offsetX = this.canvas.width / 2 - centerX * this.scale;
        this.offsetY = this.canvas.height / 2 - centerY * this.scale;

        if (this.currentRoute[0]?.floor) {
          this.currentFloor = this.currentRoute[0].floor;
          document.querySelectorAll('.floor-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.floor) === this.currentFloor);
          });
        }
      }

      fitToScreen() {
        const walls = this.walls[this.currentFloor] || [];
        const floorPoints = this.points.filter(p => p.floor === this.currentFloor);

        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

        [...walls.flatMap(w => [w.x1, w.x2]), ...floorPoints.map(p => p.x)].forEach(x => {
          if (x < minX) minX = x;
          if (x > maxX) maxX = x;
        });

        [...walls.flatMap(w => [w.y1, w.y2]), ...floorPoints.map(p => p.y)].forEach(y => {
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        });

        if (minX === Infinity) {
          this.offsetX = this.canvas.width / 2 - 400;
          this.offsetY = this.canvas.height / 2 - 300;
          this.scale = 1;
        } else {
          const padding = 50;
          minX -= padding;
          minY -= padding;
          maxX += padding;
          maxY += padding;

          const mapWidth = maxX - minX;
          const mapHeight = maxY - minY;

          this.scale = Math.min(this.canvas.width / mapWidth, this.canvas.height / mapHeight) * 0.9;
          this.scale = Math.min(Math.max(this.scale, this.minScale), this.maxScale);

          const centerX = (minX + maxX) / 2;
          const centerY = (minY + maxY) / 2;

          this.offsetX = this.canvas.width / 2 - centerX * this.scale;
          this.offsetY = this.canvas.height / 2 - centerY * this.scale;
        }

        this.draw();
      }

      setupMouseEvents() {
        this.canvas.addEventListener('mousedown', (e) => {
          this.isDragging = true;
          this.lastX = e.clientX;
          this.lastY = e.clientY;
        });

        this.canvas.addEventListener('mousemove', (e) => {
          if (this.isDragging) {
            const dx = e.clientX - this.lastX;
            const dy = e.clientY - this.lastY;
            this.offsetX += dx;
            this.offsetY += dy;
            this.lastX = e.clientX;
            this.lastY = e.clientY;
            this.draw();
          } else {
            this.checkHover(e);
          }
        });

        this.canvas.addEventListener('mouseup', () => {
          this.isDragging = false;
        });

        this.canvas.addEventListener('wheel', (e) => {
          e.preventDefault();

          const rect = this.canvas.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;

          const worldX = (mouseX - this.offsetX) / this.scale;
          const worldY = (mouseY - this.offsetY) / this.scale;

          const delta = e.deltaY > 0 ? 0.9 : 1.1;
          const newScale = Math.min(Math.max(this.scale * delta, this.minScale), this.maxScale);

          this.offsetX = mouseX - worldX * newScale;
          this.offsetY = mouseY - worldY * newScale;
          this.scale = newScale;

          this.draw();
        });
      }

      checkHover(e) {
        const rect = this.canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

        const x = (clientX - rect.left - this.offsetX) / this.scale;
        const y = (clientY - rect.top - this.offsetY) / this.scale;

        const floorPoints = this.points.filter(p => p.floor === this.currentFloor);
        let found = null;

        for (let point of floorPoints) {
          const dist = Math.sqrt(
            Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2)
          );
          if (dist < 20 / this.scale) {
            found = point;
            break;
          }
        }

        if (found) {
          this.hoveredPoint = found;
          this.tooltip.style.display = 'block';
          this.tooltip.style.left = (clientX + 10) + 'px';
          this.tooltip.style.top = (clientY + 10) + 'px';
          this.tooltip.textContent = `${found.name} (${found.floor} —ç—Ç–∞–∂)`;
        } else {
          this.hoveredPoint = null;
          this.tooltip.style.display = 'none';
        }
      }

      draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        this.ctx.save();
        this.ctx.translate(this.offsetX, this.offsetY);
        this.ctx.scale(this.scale, this.scale);

        // –°—Ç–µ–Ω—ã
        this.drawWalls();

        // –ú–∞—Ä—à—Ä—É—Ç
        if (this.currentRoute && this.currentRoute.length > 1) {
          this.drawRoute();
        }

        // –¢–æ—á–∫–∏
        this.drawPoints();

        this.ctx.restore();
      }

      drawWalls() {
        const walls = this.walls[this.currentFloor] || [];
        this.ctx.strokeStyle = '#2c3e50';
        this.ctx.lineWidth = 4 / this.scale;

        walls.forEach(wall => {
          this.ctx.beginPath();
          this.ctx.moveTo(wall.x1, wall.y1);
          this.ctx.lineTo(wall.x2, wall.y2);
          this.ctx.stroke();
        });
      }

      drawRoute() {
        this.ctx.strokeStyle = '#f39c12';
        this.ctx.lineWidth = 5 / this.scale;
        this.ctx.shadowColor = 'rgba(243, 156, 18, 0.5)';
        this.ctx.shadowBlur = 15 / this.scale;

        this.ctx.beginPath();
        this.ctx.moveTo(this.currentRoute[0].x, this.currentRoute[0].y);
        for (let i = 1; i < this.currentRoute.length; i++) {
          this.ctx.lineTo(this.currentRoute[i].x, this.currentRoute[i].y);
        }
        this.ctx.stroke();
        this.ctx.shadowBlur = 0;

        if (this.currentStep < this.currentRoute.length - 1) {
          const start = this.currentRoute[this.currentStep];
          const end = this.currentRoute[this.currentStep + 1];

          this.ctx.strokeStyle = '#f1c40f';
          this.ctx.lineWidth = 7 / this.scale;
          this.ctx.beginPath();
          this.ctx.moveTo(start.x, start.y);
          this.ctx.lineTo(end.x, end.y);
          this.ctx.stroke();

          const angle = Math.atan2(end.y - start.y, end.x - start.x);
          const arrowX = start.x + (end.x - start.x) * 0.7;
          const arrowY = start.y + (end.y - start.y) * 0.7;

          this.ctx.save();
          this.ctx.translate(arrowX, arrowY);
          this.ctx.rotate(angle);
          this.ctx.beginPath();
          this.ctx.moveTo(0, 0);
          this.ctx.lineTo(-20 / this.scale, -10 / this.scale);
          this.ctx.lineTo(-20 / this.scale, 10 / this.scale);
          this.ctx.closePath();
          this.ctx.fillStyle = '#f1c40f';
          this.ctx.fill();
          this.ctx.restore();
        }
      }

      drawPoints() {
        const floorPoints = this.points.filter(p => p.floor === this.currentFloor);

        floorPoints.forEach(point => {
          const isCurrent = this.currentLocation?.id === point.id;
          const isDest = this.destination?.id === point.id;

          let color = '#95a5a6';
          if (point.category === 'classroom') color = '#3498db';
          else if (point.category === 'entrance') color = '#27ae60';
          else if (point.category === 'toilet') color = '#e67e22';
          else if (point.category === 'cafeteria') color = '#e74c3c';
          else if (point.category === 'stair') color = '#9b59b6';
          else if (point.category === 'elevator') color = '#f1c40f';

          if (isCurrent) color = '#27ae60';
          if (isDest) color = '#e74c3c';

          const size = (isCurrent || isDest) ? 12 : 8;

          this.ctx.shadowColor = 'transparent';

          this.ctx.beginPath();
          this.ctx.arc(point.x, point.y, size / this.scale, 0, 2 * Math.PI);
          this.ctx.fillStyle = color;
          this.ctx.fill();

          this.ctx.strokeStyle = 'white';
          this.ctx.lineWidth = 2 / this.scale;
          this.ctx.stroke();
        });
      }

      showSuccess(message) {
        this.successMessage.textContent = message;
        this.successMessage.classList.add('active');
        this.errorMessage.classList.remove('active');
        setTimeout(() => this.successMessage.classList.remove('active'), 3000);
      }

      showError(message) {
        this.errorMessage.textContent = message;
        this.errorMessage.classList.add('active');
        this.successMessage.classList.remove('active');
        setTimeout(() => this.errorMessage.classList.remove('active'), 3000);
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    window.toggleFullscreen = function() {
      document.body.classList.add('fullscreen-mode');
    };

    window.exitFullscreen = function() {
      document.body.classList.remove('fullscreen-mode');
    };

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤
    window.switchQRMode = function(mode) {
      document.querySelectorAll('.qr-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.qr-content').forEach(content => content.classList.remove('active'));

      if (mode === 'camera') {
        document.querySelector('[onclick="switchQRMode(\'camera\')"]').classList.add('active');
        document.getElementById('camera-mode').classList.add('active');
      } else {
        document.querySelector('[onclick="switchQRMode(\'file\')"]').classList.add('active');
        document.getElementById('file-mode').classList.add('active');
      }
    };

    window.startCamera = function() {
      if (map) {
        map.startCamera();
      }
    };

    let map;

    document.addEventListener('DOMContentLoaded', () => {
      map = new SchoolMap();
    });
  </script>
</body>
</html>