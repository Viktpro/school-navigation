<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∫–æ–ª–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            color: #fff;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 320px;
            background: #2d2d2d;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: #363636;
            border-bottom: 1px solid #404040;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header p {
            font-size: 14px;
            color: #aaa;
        }

        /* –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
        .location-card {
            background: #363636;
            margin: 15px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #404040;
        }

        .location-title {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-value {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-badge {
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .location-actions {
            display: flex;
            gap: 8px;
        }

        .location-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #404040;
            border-radius: 8px;
            background: #2d2d2d;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }

        .location-btn:hover {
            background: #404040;
            border-color: #666;
        }

        .location-btn.primary {
            background: #0078d4;
            border-color: #0078d4;
        }

        .location-btn.primary:hover {
            background: #006cbd;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            margin: 0 15px 15px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #404040;
            border-radius: 8px;
            background: #363636;
            color: #fff;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: #666;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        /* –°–ø–∏—Å–æ–∫ –º–µ—Å—Ç */
        .places-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 15px;
        }

        .place-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #363636;
            border: 1px solid #404040;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .place-item:hover {
            background: #404040;
            border-color: #666;
            transform: translateX(4px);
        }

        .place-item.selected {
            border-color: #0078d4;
            background: #1e3a5f;
        }

        .place-icon {
            width: 40px;
            height: 40px;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .place-info {
            flex: 1;
        }

        .place-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .place-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #aaa;
        }

        /* –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-panel {
            background: #363636;
            border-top: 1px solid #404040;
            padding: 15px;
            display: none;
        }

        .route-panel.active {
            display: block;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .route-distance {
            font-size: 20px;
            font-weight: 700;
            color: #0078d4;
        }

        .route-time {
            color: #4caf50;
            font-size: 14px;
        }

        .route-steps {
            font-size: 13px;
            color: #aaa;
            line-height: 1.6;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 6px;
        }

        /* –ö–∞—Ä—Ç–∞ */
        .map-container {
            flex: 1;
            position: relative;
            background: #1e1e1e;
            overflow: hidden;
        }

        #mapCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #mapCanvas:active {
            cursor: grabbing;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .map-controls {
            position: absolute;
            right: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 8px;
            background: #2d2d2d;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #404040;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #404040;
            border-color: #666;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–∂–µ–π */
        .floor-control {
            position: absolute;
            left: 20px;
            top: 20px;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            display: flex;
            overflow: hidden;
            z-index: 10;
        }

        .floor-btn {
            padding: 12px 20px;
            border: none;
            background: #2d2d2d;
            color: #aaa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            border-right: 1px solid #404040;
        }

        .floor-btn:last-child {
            border-right: none;
        }

        .floor-btn:hover {
            background: #404040;
            color: #fff;
        }

        .floor-btn.active {
            background: #0078d4;
            color: white;
        }

        /* –ú–∞—Å—à—Ç–∞–± */
        .scale-bar {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .scale-line {
            width: 80px;
            height: 2px;
            background: #666;
            position: relative;
        }

        .scale-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -3px;
            width: 2px;
            height: 8px;
            background: #666;
        }

        .scale-line::before {
            content: '';
            position: absolute;
            left: 0;
            top: -3px;
            width: 2px;
            height: 8px;
            background: #666;
        }

        /* –ú–∞—Ä–∫–µ—Ä "–í—ã –∑–¥–µ—Å—å" */
        .you-are-here {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #0078d4;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #0078d4;
            animation: pulse 2s infinite;
            z-index: 20;
            pointer-events: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(0, 120, 212, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 120, 212, 0);
            }
        }

        /* QR-—Å–∫–∞–Ω–µ—Ä */
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .qr-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #404040;
        }

        .qr-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .qr-modal-header h2 {
            font-size: 18px;
        }

        .qr-modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }

        .qr-modal-close:hover {
            color: #fff;
        }

        #qr-reader {
            width: 100%;
            min-height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            background: #2d2d2d;
            color: #fff;
            border-left: 4px solid #0078d4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üè´ –®–∫–æ–ª–∞</h1>
                <p>–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–¥–∞–Ω–∏—é</p>
            </div>

            <!-- –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ -->
            <div class="location-card">
                <div class="location-title">üìç –í–´ –ó–î–ï–°–¨</div>
                <div class="location-value" id="currentLocation">
                    <span>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                    <span class="location-badge" id="currentFloor">-</span>
                </div>
                <div class="location-actions">
                    <button class="location-btn" id="scanQRBtn">
                        üì∑ QR-–∫–æ–¥
                    </button>
                    <button class="location-btn primary" id="myLocationBtn">
                        üéØ –ú–æ–µ –º–µ—Å—Ç–æ
                    </button>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫–∞–±–∏–Ω–µ—Ç–∞...">
                <span class="search-icon">üîç</span>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –º–µ—Å—Ç -->
            <div class="places-list" id="placesList">
                <!-- –¢–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ -->
            <div class="route-panel" id="routePanel">
                <div class="route-header">
                    <div class="route-info">
                        <span class="route-distance" id="routeDistance">0 –º–∏–Ω</span>
                        <span class="route-time" id="routeTime">0 –º</span>
                    </div>
                    <button class="close-btn" onclick="document.getElementById('routePanel').classList.remove('active')">‚úï</button>
                </div>
                <div class="route-steps" id="routeSteps">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <canvas id="mapCanvas"></canvas>

            <!-- –ú–∞—Ä–∫–µ—Ä "–í—ã –∑–¥–µ—Å—å" -->
            <div class="you-are-here" id="youAreHere" style="display: none;"></div>

            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="map-controls">
                <button class="control-btn" id="zoomIn">‚ûï</button>
                <button class="control-btn" id="zoomOut">‚ûñ</button>
                <button class="control-btn" id="resetView">‚ü≤</button>
            </div>

            <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–∂–µ–π -->
            <div class="floor-control">
                <button class="floor-btn active" data-floor="1">1</button>
                <button class="floor-btn" data-floor="2">2</button>
                <button class="floor-btn" data-floor="3">3</button>
            </div>

            <!-- –ú–∞—Å—à—Ç–∞–± -->
            <div class="scale-bar">
                <span class="scale-line"></span>
                <span id="scaleValue">50 –º</span>
            </div>
        </div>
    </div>

    <!-- QR-—Å–∫–∞–Ω–µ—Ä -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h2>üì∑ –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h2>
                <button class="qr-modal-close" onclick="document.getElementById('qrModal').style.display='none'">‚úï</button>
            </div>
            <div id="qr-reader"></div>
            <p style="text-align: center; margin-top: 16px; color: #aaa; font-size: 14px;">
                –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –Ω–∞ –∫–∞–±–∏–Ω–µ—Ç–µ
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        class SchoolMap {
            constructor() {
                this.canvas = document.getElementById('mapCanvas');
                this.ctx = this.canvas.getContext('2d');

                // –†–∞–∑–º–µ—Ä—ã
                this.canvas.width = window.innerWidth - 320;
                this.canvas.height = window.innerHeight;

                // –î–∞–Ω–Ω—ã–µ
                this.points = [];
                this.walls = {
                    1: [],
                    2: [],
                    3: []
                };

                // –°–æ—Å—Ç–æ—è–Ω–∏–µ
                this.currentFloor = 1;
                this.scale = 1;
                this.offsetX = 0;
                this.offsetY = 0;
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;

                // –¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                this.startPoint = null;
                this.endPoint = null;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                this.loadData();
                this.init();
            }

            async loadData() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–∫–∏
                    const pointsRes = await fetch('/api/points');
                    this.points = await pointsRes.json();

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–µ–Ω—ã
                    const wallsRes = await fetch('/api/load-map');
                    const wallsData = await wallsRes.json();

                    if (wallsData.floors) {
                        this.walls = {
                            1: wallsData.floors[1]?.walls || [],
                            2: wallsData.floors[2]?.walls || [],
                            3: wallsData.floors[3]?.walls || []
                        };
                    }

                    this.populatePlacesList();
                    this.draw();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                }
            }

            init() {
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', () => this.onMouseUp());
                this.canvas.addEventListener('wheel', (e) => this.onWheel(e));

                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–∂–µ–π
                document.querySelectorAll('.floor-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const floor = parseInt(btn.dataset.floor);
                        this.changeFloor(floor);
                    });
                });

                // QR-—Å–∫–∞–Ω–µ—Ä
                document.getElementById('scanQRBtn').addEventListener('click', () => this.openQRScanner());
                document.getElementById('myLocationBtn').addEventListener('click', () => this.goToMyLocation());

                // –ü–æ–∏—Å–∫
                document.getElementById('searchInput').addEventListener('input', (e) => this.search(e.target.value));

                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth - 320;
                    this.canvas.height = window.innerHeight;
                    this.draw();
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ —Ç–æ—á–∫—É –∏–∑ QR
                this.checkQRParams();
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.save();
                this.ctx.translate(this.offsetX, this.offsetY);
                this.ctx.scale(this.scale, this.scale);

                // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
                this.drawGrid();

                // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—ã
                this.drawWalls();

                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
                this.drawPoints();

                // –†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç
                if (this.startPoint && this.endPoint) {
                    this.drawRoute();
                }

                this.ctx.restore();

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–±
                this.updateScale();
            }

            drawGrid() {
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 0.5 / this.scale;

                const step = 50;
                const startX = -this.offsetX / this.scale;
                const startY = -this.offsetY / this.scale;
                const endX = startX + this.canvas.width / this.scale;
                const endY = startY + this.canvas.height / this.scale;

                for (let x = Math.floor(startX / step) * step; x < endX; x += step) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, startY);
                    this.ctx.lineTo(x, endY);
                    this.ctx.stroke();
                }

                for (let y = Math.floor(startY / step) * step; y < endY; y += step) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(startX, y);
                    this.ctx.lineTo(endX, y);
                    this.ctx.stroke();
                }
            }

            drawWalls() {
                const walls = this.walls[this.currentFloor] || [];

                this.ctx.strokeStyle = '#4a90e2';
                this.ctx.lineWidth = 4 / this.scale;
                this.ctx.lineCap = 'round';

                walls.forEach(wall => {
                    this.ctx.beginPath();
                    this.ctx.moveTo(wall.x1, wall.y1);
                    this.ctx.lineTo(wall.x2, wall.y2);
                    this.ctx.stroke();
                });
            }

            drawPoints() {
                const floorPoints = this.points.filter(p => p.floor === this.currentFloor);

                floorPoints.forEach(point => {
                    const isStart = this.startPoint?.id === point.id;
                    const isEnd = this.endPoint?.id === point.id;

                    // –¶–≤–µ—Ç —Ç–æ—á–∫–∏
                    let color = '#aaa';
                    if (point.category === 'classroom') color = '#4a90e2';
                    else if (point.category === 'entrance') color = '#4caf50';
                    else if (point.category === 'toilet') color = '#f44336';
                    else if (point.category === 'cafeteria') color = '#ff9800';

                    if (isStart) color = '#4caf50';
                    if (isEnd) color = '#f44336';

                    // –¢–µ–Ω—å
                    this.ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    this.ctx.shadowBlur = 10 / this.scale;

                    // –ö—Ä—É–≥
                    this.ctx.beginPath();
                    this.ctx.arc(point.x, point.y, 10 / this.scale, 0, 2 * Math.PI);
                    this.ctx.fillStyle = color;
                    this.ctx.fill();

                    // –û–±–≤–æ–¥–∫–∞
                    this.ctx.shadowBlur = 0;
                    this.ctx.strokeStyle = 'white';
                    this.ctx.lineWidth = 2 / this.scale;
                    this.ctx.stroke();

                    // –ò–∫–æ–Ω–∫–∞
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = `${12 / this.scale}px Arial`;
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';

                    let icon = 'üìç';
                    if (point.category === 'classroom') icon = 'üìö';
                    else if (point.category === 'toilet') icon = 'üöª';
                    else if (point.category === 'cafeteria') icon = 'üçΩÔ∏è';

                    if (isStart) icon = 'üìç';
                    if (isEnd) icon = 'üèÅ';

                    this.ctx.fillText(icon, point.x, point.y - 1);

                    // –ù–∞–∑–≤–∞–Ω–∏–µ
                    if (this.scale > 0.7) {
                        this.ctx.shadowColor = 'white';
                        this.ctx.shadowBlur = 4 / this.scale;
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = `bold ${11 / this.scale}px Arial`;
                        this.ctx.fillText(point.name, point.x, point.y - 25 / this.scale);
                    }
                });
            }

            drawRoute() {
                if (!this.startPoint || !this.endPoint) return;

                const points = [];
                if (this.startPoint.floor === this.currentFloor) {
                    points.push(this.startPoint);
                }
                if (this.endPoint.floor === this.currentFloor) {
                    points.push(this.endPoint);
                }

                if (points.length < 2) return;

                this.ctx.beginPath();
                this.ctx.strokeStyle = '#4caf50';
                this.ctx.lineWidth = 3 / this.scale;
                this.ctx.setLineDash([10 / this.scale, 5 / this.scale]);

                this.ctx.moveTo(points[0].x, points[0].y);
                this.ctx.lineTo(points[1].x, points[1].y);
                this.ctx.stroke();

                this.ctx.setLineDash([]);
            }

            onMouseDown(e) {
                this.isDragging = true;
                this.lastX = e.clientX;
                this.lastY = e.clientY;
                this.canvas.style.cursor = 'grabbing';
            }

            onMouseMove(e) {
                if (this.isDragging) {
                    const dx = e.clientX - this.lastX;
                    const dy = e.clientY - this.lastY;
                    this.offsetX += dx;
                    this.offsetY += dy;
                    this.lastX = e.clientX;
                    this.lastY = e.clientY;
                    this.draw();
                }
            }

            onMouseUp() {
                this.isDragging = false;
                this.canvas.style.cursor = 'grab';
            }

            onWheel(e) {
                e.preventDefault();

                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const worldX = (mouseX - this.offsetX) / this.scale;
                const worldY = (mouseY - this.offsetY) / this.scale;

                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.min(Math.max(0.3, this.scale * delta), 3);

                this.offsetX = mouseX - worldX * newScale;
                this.offsetY = mouseY - worldY * newScale;
                this.scale = newScale;

                this.draw();
            }

            changeFloor(floor) {
                this.currentFloor = floor;
                document.querySelectorAll('.floor-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.floor) === floor);
                });
                this.draw();
            }

            zoomIn() {
                this.scale = Math.min(this.scale * 1.2, 3);
                this.draw();
            }

            zoomOut() {
                this.scale = Math.max(this.scale / 1.2, 0.3);
                this.draw();
            }

            resetView() {
                this.scale = 1;
                this.offsetX = this.canvas.width / 2 - 400;
                this.offsetY = this.canvas.height / 2 - 300;
                this.draw();
            }

            updateScale() {
                const metersPerPixel = 0.5 / this.scale;
                const scaleInMeters = Math.round(50 * metersPerPixel * 100);
                document.getElementById('scaleValue').textContent = `${scaleInMeters} –º`;
            }

            populatePlacesList() {
                const list = document.getElementById('placesList');
                list.innerHTML = '';

                this.points.forEach(point => {
                    const div = document.createElement('div');
                    div.className = 'place-item';
                    div.dataset.id = point.id;

                    let icon = 'üìç';
                    if (point.category === 'classroom') icon = 'üìö';
                    else if (point.category === 'toilet') icon = 'üöª';
                    else if (point.category === 'cafeteria') icon = 'üçΩÔ∏è';

                    div.innerHTML = `
                        <div class="place-icon">${icon}</div>
                        <div class="place-info">
                            <div class="place-name">${point.name}</div>
                            <div class="place-meta">
                                <span>${point.floor} —ç—Ç–∞–∂</span>
                                <span>${point.category}</span>
                            </div>
                        </div>
                    `;

                    div.addEventListener('click', () => {
                        this.selectDestination(point);
                    });

                    list.appendChild(div);
                });
            }

            selectDestination(point) {
                if (!this.startPoint) {
                    this.showNotification('–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    return;
                }

                this.endPoint = point;

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                const distance = Math.sqrt(
                    Math.pow(this.startPoint.x - point.x, 2) +
                    Math.pow(this.startPoint.y - point.y, 2)
                );

                const meters = Math.round(distance * 0.5);
                const minutes = Math.max(1, Math.round(meters / 70));

                document.getElementById('routeDistance').textContent = `${minutes} –º–∏–Ω`;
                document.getElementById('routeTime').textContent = `${meters} –º`;

                let steps = `–û—Ç ${this.startPoint.name}`;
                if (this.startPoint.floor !== point.floor) {
                    steps += ` ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ${point.floor} —ç—Ç–∞–∂ ‚Üí ${point.name}`;
                } else {
                    steps += ` ‚Üí ${point.name}`;
                }

                document.getElementById('routeSteps').textContent = steps;
                document.getElementById('routePanel').classList.add('active');

                this.changeFloor(this.startPoint.floor);
                this.draw();
            }

            openQRScanner() {
                const modal = document.getElementById('qrModal');
                modal.style.display = 'block';

                const scanner = new Html5Qrcode("qr-reader");

                scanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        try {
                            const url = new URL(decodedText);
                            const pointId = url.searchParams.get('point');

                            if (pointId) {
                                const point = this.points.find(p => p.id === pointId);
                                if (point) {
                                    this.setLocation(point);
                                    scanner.stop();
                                    modal.style.display = 'none';
                                }
                            }
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ QR:', e);
                        }
                    },
                    (error) => console.log(error)
                );
            }

            setLocation(point) {
                this.startPoint = point;
                document.getElementById('currentLocation').innerHTML = `
                    <span>${point.name}</span>
                    <span class="location-badge">${point.floor} —ç—Ç–∞–∂</span>
                `;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
                const marker = document.getElementById('youAreHere');
                marker.style.display = 'block';

                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–æ—á–∫–µ
                this.centerOnPoint(point);

                this.showNotification(`üìç –í—ã –∑–¥–µ—Å—å: ${point.name}`);
            }

            centerOnPoint(point) {
                this.offsetX = this.canvas.width / 2 - point.x * this.scale;
                this.offsetY = this.canvas.height / 2 - point.y * this.scale;
                this.changeFloor(point.floor);
                this.draw();

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
                const marker = document.getElementById('youAreHere');
                marker.style.left = (this.canvas.width / 2) + 'px';
                marker.style.top = (this.canvas.height / 2) + 'px';
            }

            goToMyLocation() {
                if (this.startPoint) {
                    this.centerOnPoint(this.startPoint);
                } else {
                    this.showNotification('–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥');
                }
            }

            checkQRParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const pointId = urlParams.get('point');

                if (pointId) {
                    const point = this.points.find(p => p.id === pointId);
                    if (point) {
                        this.setLocation(point);
                    }
                }
            }

            search(query) {
                if (query.length < 2) return;

                const results = this.points.filter(p =>
                    p.name.toLowerCase().includes(query.toLowerCase())
                );

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Å–ø–∏—Å–∫–µ
                document.querySelectorAll('.place-item').forEach(item => {
                    const match = results.some(r => r.id === item.dataset.id);
                    item.style.display = match ? 'flex' : 'none';
                });
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => notification.remove(), 3000);
            }
        }

        // –ó–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', () => {
            window.schoolMap = new SchoolMap();
        });
    </script>
</body>
</html>